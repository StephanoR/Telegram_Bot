name: Deploy to Cloud Run

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - uses: google-github-actions/setup-gcloud@v1

    - run: gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT }}/telegram-bot

    - run: >
        gcloud run deploy telegram-bot
        --image gcr.io/${{ secrets.GCP_PROJECT }}/telegram-bot
        --region europe-west1
        --platform managed
        --allow-unauthenticated
        --set-env-vars BOT_TOKEN=${{ secrets.BOT_TOKEN }},WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}
